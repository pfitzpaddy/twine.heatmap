<!DOCTYPE html>
<html>
<head>
    <title>Twine Heatmap</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <style>
        #map { width: 100%; height: 600px; }
        body { font: 16px/1.4 "Helvetica Neue", Arial, sans-serif; }
        .ghbtns { position: relative; top: 4px; margin-left: 5px; }
        a { color: #0077ff; }
    </style>
</head>
<body>

<div id="map"></div>
<script>

// init heatmap
$( document ).ready(function() {    

    var pixelBounds,
        bbox,
        heatmap;

    var map = L.map('map', {
        center: [-0.48, 110],
        zoom: 6,
        crs: L.CRS.EPSG3857
    });

    var tiles = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '<a href="https://www.mapbox.com/about/maps/">Terms and Feedback</a>',
        id: 'examples.map-20v6611k'
    }).addTo(map);

    map.on('moveend', function(){
        // 
        getHeatmap();
    });

    // $.ajax({
    //     url: "lib/ww2_thor_pt.min.json",
    //     success: function( json ) {
    //         L.geoJson(json).addTo(map);
    //     }
    // });

    //
    getHeatmap();


    function toXY(lat, lng, map) {
        var projected = map.options.crs.projection.project(L.latLng(lat, lng))
        return projected.multiplyBy(6378137);
    }

    function toLatLng(x, y, map) {
        var projected = L.point(y, x).divideBy(6378137);
        return map.options.crs.projection.unproject(projected);
    }
    
    function getHeatmap() {

        // Get image size and bounds
        size = [map.getPixelBounds().max.x - map.getPixelBounds().min.x, map.getPixelBounds().max.y - map.getPixelBounds().min.y];
        imageBounds = [[map.getBounds()._southWest.lat,map.getBounds()._southWest.lng],[map.getBounds()._northEast.lat,map.getBounds()._northEast.lng]];

        // Remove layer if exits
        if ( heatmap ){
            map.removeLayer( heatmap );
        }

        // Send request to return heatmap
        $.ajax({
            url: 'lib/heatmap.service.php',
            type: 'post',
            dataType: "json",
            data: {
                size: size,
                bounds: imageBounds
            },
            // work with the response
            success: function( response ) {
                var imageUrl = 'imgs/' + response.filename + '.png';     

                heatmap = L.imageOverlay(imageUrl, imageBounds);
                map.addLayer(heatmap);
            }
        });
    }

});

</script>
</body>
</html>
